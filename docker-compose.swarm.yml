version: '3.8'

services:
  # W9 Mail Backend
  w9-mail-backend:
    image: ghcr.io/${GITHUB_USER:-your-username}/w9-mail-backend:latest
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "${W9_MAIL_PORT:-10106}:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - DATABASE_PATH=/app/data/w9mail.db
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID:-}
      - MICROSOFT_CLIENT_SECRET_ID=${MICROSOFT_CLIENT_SECRET_ID:-}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET:-}
      - MICROSOFT_CLIENT_VALUE=${MICROSOFT_CLIENT_VALUE:-}
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID:-}
      - MICROSOFT_REDIRECT_URI=${MICROSOFT_REDIRECT_URI:-https://w9.nu/api/auth/microsoft/callback}
      - MICROSOFT_SCOPE=${MICROSOFT_SCOPE:-https://graph.microsoft.com/.default}
      - JWT_SECRET=${W9_MAIL_JWT_SECRET:-}
      - APP_WEB_BASE_URL=${W9_MAIL_BASE_URL:-https://w9.nu}
      - TURNSTILE_SECRET_KEY=${W9_MAIL_TURNSTILE_SECRET:-}
    volumes:
      - w9-mail-data:/app/data
    networks:
      - w9-mail-network
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == worker
          # Optional: pin to specific nodes
          # - node.hostname == vps-5
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # W9 Mail Frontend
  w9-mail-frontend:
    image: ghcr.io/${GITHUB_USER:-your-username}/w9-mail-frontend:latest
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    ports:
      - "${W9_MAIL_FRONTEND_PORT:-8082}:80"
    networks:
      - w9-mail-network
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == worker

  # Watchtower - Auto-update containers
  watchtower:
    image: containrrr/watchtower:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_LABEL_ENABLE=true
    command: --interval 300 --scope w9-mail-backend w9-mail-frontend
    networks:
      - w9-mail-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure

volumes:
  w9-mail-data:
    driver: local

networks:
  w9-mail-network:
    driver: overlay

